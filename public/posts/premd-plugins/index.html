<!doctype html>

<html lang="en">

<head>
  <title>Mailund on the Internet</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="Thomas Mailund" />
  <meta name="generator" content="Hugo 0.37.1" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

<link rel="stylesheet" type="text/css" href="https://mailund.dk/css/styles.css" />

 
       <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid Sans" type="text/css" media="all" />
     
       <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira Code" type="text/css" media="all" />
     

 <style>
 body {
     font-family: 'Droid Sans';
 }
 code {
    font-family: 'Fira Code'; 
 }
 </style>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-10582357-1', 'auto');
ga('send', 'pageview');
</script>

</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://mailund.dk/">Mailund on the Internet</a>
            </h1>

      <ul id="social-media">
        
        <li><a href="https://twitter.com/ThomasMailund"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.linkedin.com/in/thomas-mailund-94153b1"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://github.com/mailund"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://www.facebook.com/mailund"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://patreon.com/mailund"><i class="fab fa-patreon fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.goodreads.com/author/show/15484380.Thomas_Mailund"><i class="fab fa-goodreads fa-lg" aria-hidden="true"></i></a></li>
        
      </ul>
      
      <p><em>On Writing, Science, Programming and more</em></p>
      

    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://mailund.dk/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/books/">
                <i class="fa-li fa  fa-lg"></i><span>Books</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/publications/">
                <i class="fa-li fa  fa-lg"></i><span>Publications</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/software/">
                <i class="fa-li fa  fa-lg"></i><span>Software</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Premarkdown Plugins</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-09-10T14:25:40&#43;02:00">Sep 10, 2018</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="https://mailund.dk/tags/writing/">#writing</a>
                
                    , 
                    <a href="https://mailund.dk/tags/python/">#python</a>
                
                    , 
                    <a href="https://mailund.dk/tags/programming/">#programming</a>
                
            </em>
        </li>
        

        <li>7 min read</li>
    </ul>
</aside>
    

    

<p>I&rsquo;m working on a preprocessor for Markdown documents. I write all my books in Markdown, so this is something I have wanted to do for a while, to scratch a few itches I have.</p>

<p>I write my books in Markdown and then I process them using Pandoc. If you are not familiar with that setup, then I have written a short book on the topic: <a href="https://amzn.to/2MYEMUC"><em>The Beginner&rsquo;s Guide to Markdown and Pandoc</em></a>.</p>

<p>For that book, because it is very short, I just have a single Markdown document containing the entire book, but usually, I have one file per chapter. Pandoc doesn&rsquo;t handle that, but you can cat the files before you convert the Markdown source to PDF or ePUB documents. That works well enough, but you need to keep track of the chapter order and such, of course.</p>

<p>I handle that with Makefiles, but any script would work just as well. There is just one thing I don&rsquo;t particularly like with this. It is difficult to move sections around within the chapters—you have to cut and paste to do this. Plus, if you want to have some markup inside the documents, as comments, then Pandoc cannot handle that.</p>

<p>I write using iA Writer, and there you can include other files by just writing slash and then the filename. Like this:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown"><span style="color:#000080;font-weight:bold">#</span> The main title
<span style="">
</span><span style=""></span>/chapter1.md<span style="">
</span><span style=""></span>/chapter2.md<span style="">
</span><span style=""></span>/chapter3.md</code></pre></div>
<p>That will include the three chapter-files into the main document. That doesn&rsquo;t solve particularly much, but you can then include sections from the chapter files and such. This makes it easy to move sections and chapters around—similar to how Ulysses deals with sections.</p>

<p>I stopped using Ulysses when the changed to a subscription plan, but I was annoyed with having to export Markdown documents from it every time I needed to compile a document. I miss moving sections around, but not exporting. I don&rsquo;t have to export anything when writing in iA Writer, but Pandoc doesn&rsquo;t include files the same way as iA Writer does.</p>

<p>So, I wanted to have a preprocessing step that flattens a hierarchy of included files before compiling a document. I don&rsquo;t want to keep track of that in a Makefile, but just include sections from chapters and include chapters from a main file. I wrote a script, <code>premd</code> to handle this.</p>

<p>If I preprocess files to flatten the hierarchy, then I can also add tags for comments. So I decided to use <code>%%</code> to start comments, and my preprocessor does not include lines that start with that in the output.</p>

<p>I want to do more with comments than ignore them, though. I want to be able to add writing goals and FIXME statements so I can extract meta-information while I process the document.</p>

<p>So, I decided to use a plugin mechanism to add two ways of extracting meta-information. I have two types right now; I call them them &ldquo;tag&rdquo; plugins and &ldquo;observer&rdquo; plugins</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">TagPlugin</span>(abc<span style="color:#666">.</span>ABC):
	<span style="color:#555;font-weight:bold">@abc.abstractmethod</span>
	<span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">handle_tag</span>(self, <span style="color:#007020">file</span>, lineno, content):
		<span style="color:#007020;font-weight:bold">pass</span>

<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ObserverPlugin</span>(abc<span style="color:#666">.</span>ABC):
    <span style="color:#555;font-weight:bold">@abc.abstractmethod</span>
    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">observe_line</span>(self, filename, lineno, line):
        <span style="color:#007020;font-weight:bold">pass</span></code></pre></div>
<p>and those plugins I want to display summaries of the document after I have processed it (or if I just want to extract summaries) I call &ldquo;summary&rdquo; plugins</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SummaryPlugin</span>(abc<span style="color:#666">.</span>ABC):
    <span style="color:#555;font-weight:bold">@abc.abstractmethod</span>
    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">summarize</span>(self, outfile):
        <span style="color:#007020;font-weight:bold">pass</span></code></pre></div>
<p>You can combine these anyway you want, and I currently have two concrete plugins: &ldquo;WC&rdquo; for word counts and &ldquo;FIXME&rdquo; for extracting &ldquo;fixme&rdquo; information.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">WC</span>(plugin<span style="color:#666">.</span>ObserverPlugin, plugin<span style="color:#666">.</span>SummaryPlugin):
	<span style="">…</span>
	
<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">FIXME</span>(plugin<span style="color:#666">.</span>TagPlugin, plugin<span style="color:#666">.</span>SummaryPlugin):
	<span style="">…</span></code></pre></div>
<p>They are both summary plugins because they should output summary information, but the word count plugin observes the entire document while the fixme plugin only observes &ldquo;tags&rdquo; and summarises data it gets from these.</p>

<p>The observer plugins are fed all lines in the document, after it is flattened, while the tag plugins sees comment lines that starts with a tag it tells the preprocessor it wants to see.</p>

<p>The &ldquo;FIXME&rdquo; plugin sees these tags:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">FIXME</span>(plugin<span style="color:#666">.</span>TagPlugin, plugin<span style="color:#666">.</span>SummaryPlugin):
    <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;&#34;&#34;FIXMEs in document&#34;&#34;&#34;</span>
    supported_tags <span style="color:#666">=</span> [
        <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;FIXME&#34;</span>, <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;Fixme&#34;</span>, <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;fixme&#34;</span>,
        <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;TODO&#34;</span>, <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;Todo&#34;</span>, <span style="color:#4070a0"></span><span style="color:#4070a0">&#34;todo&#34;</span>
    ]
	<span style="">…</span></code></pre></div>
<p>When <code>permed</code> is told there is a tag plugin, it gets the class-variable <code>supported_tags</code> and feed these tags to the plugin. The tags have the form <code>%% tag: …</code>, and the tag plugin is called with the text that follows the <code>tag:</code>.</p>

<p>You can inform the <code>premd</code> too that you have a plugin for it using entry points. I have these built into the tool:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    entry_points<span style="color:#666">=</span>{
		    <span style="">…</span>,
        <span style="color:#4070a0"></span><span style="color:#4070a0">&#39;premd.plugins&#39;</span>: [
            <span style="color:#4070a0"></span><span style="color:#4070a0">&#39;fixme = premd.plugins.fixme:FIXME&#39;</span>,
            <span style="color:#4070a0"></span><span style="color:#4070a0">&#39;wc = premd.plugins.wc:WC&#39;</span>
        ]
    },</code></pre></div>
<p>The tool figures out what kind of a plugin it is from its super-classes. I can also get these from a more protocol-oriented design using the <code>__subclasshook__</code> mechanism, but I haven&rsquo;t decided on whether that is a good idea or not.</p>

<p>This works okay now. I can extract <code>FIXME</code> comments and I can extract word-counts (per chapter, section, etc.). But I am never satisfied and I want more!</p>

<p>There are two things I want to add to <code>premd</code> as soon as I have time: I want to handle tags in a smarter way, and I want to allow plugins to add to the document and not just read from it.</p>

<h2 id="smarter-tag-handling">Smarter tag handling</h2>

<p>The tag plugin mechanism is okay I guess. I can add writing goals to a section or chapter using a <code>%% goals:</code> tag, I guess, and make the word count plugin read those. It will work, but I think I can do better than that. If I use the current design, I can only call tag handlers with a string, but since I can inspect classes and methods, I think I should be able to use tags to call specific methods, for example write</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown"><span style="color:#000080;font-weight:bold">#</span> A section
%% wordcount.set_goals: goal: 5000</code></pre></div>
<p>or</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown"><span style="color:#000080;font-weight:bold">#</span> A section
%% wordcount.set_goals: at_least: 4500 at_most: 5500</code></pre></div>
<p>and make those tags call the word counter plugin using keyword arguments</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plugin<span style="color:#666">.</span>get_goals(goal<span style="color:#666">=</span><span style="color:#40a070">5000</span>)</code></pre></div>
<p>or</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plugin<span style="color:#666">.</span>set_goals(at_least<span style="color:#666">=</span><span style="color:#40a070">4500</span>, at_most<span style="color:#666">=</span><span style="color:#40a070">5500</span>)</code></pre></div>
<p>and automatically convert the arguments if the method has type annotations.</p>

<p>This is a lot more flexible, and I don&rsquo;t think it will be terribly hard to implement. I haven&rsquo;t thought too deeply about what the design should be to make this work, but designing the interface is probably a lot harder than actually implementing it.</p>

<h2 id="adding-to-the-output-stream-of-the-flattening">Adding to the output stream of the flattening</h2>

<p>To have an actual preprocessor, I want to allow plugins to add to the document as well as inspect it. I am not sure what the right interface should be here, though.</p>

<p>It is probably easiest to use tags for this. I could add the output stream to the function call that handles tags, for example, or check if it is a generator and then get lines it output using <code>yield from</code>.</p>

<p>If a plugin is a co-routine, I would also be able to pass information back to the plugin, but that might just as easily be handled by tags. I don&rsquo;t know yet.</p>

<p>I think my main concerns with designing this would be how to handle the setup of plugins and how to provide multi-line input to plugins.</p>

<p>If there is any kind of complex setup for a plugin, I want to be able to handle that in a configuration file or in the main document itself. So I need some sort of block-tag to handle that. A block-tag will also allow me to give a plugin larger chunks of input to process.</p>

<p>R Markdown handles blocks with headers in curly braces, and if I add a similar design I could write something like this:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-markdown" data-lang="markdown">```{pluginname, keyword=foo, arguments=bar}<span style="">
</span><span style=""></span>input to plugin</code></pre></div>
<p>The plugin can then do whatever it wants with the input, for example setup the state of the plugin or use it to produce output.</p>

<p>With R Markdown, the <code>knitr</code> tool will let you execute and output R code, but with a general design I could imagine plugins that execute arbitrary code, or for example compile code into executables (for complied languages like <code>C</code> or <code>go</code>) and get the output for this. If it doesn&rsquo;t produce output, perhaps it can test code instead. With the right design for this, I can leave it up to the plugins.</p>

<p>I am not sure if this will suffice for conditional inclusions of part of a document. I haven&rsquo;t thought too much about this, since I haven&rsquo;t used conditional sections in a while, but it might require a different kind of plugin or a chance to the <code>premd</code> tool.</p>

<p>Anyway, I would love to hear your ideas, and if you want to take the tool for a test drive you can get it on <a href="https://github.com/mailund/premarkdown">GitHub</a>.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://mailund.dk/posts/fluent-python/"><i class="fa fa-chevron-circle-left"></i> Fluent Python</a>
        </li>
        
        
        <li>
            <a href="https://mailund.dk/posts/the-coming-storm/">The Coming Storm <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    
        <section class="comments-block">
      <button id="show-comments" style="display: none;"><i class="fa fa-comments-o"></i> Add/View Comments</button>
</section>

<section id="disqus_thread"></section>

<script>
      (function () {
            
            
            if (window.location.hostname == "localhost")
                  return;

            var disqus_loaded = false;
            var disqus_shortname = 'mailund-dk';
            var disqus_button = document.getElementById("show-comments");

            disqus_button.style.display = "";
            disqus_button.addEventListener("click", disqus, false);

            function disqus() {

                  if (!disqus_loaded) {
                        disqus_loaded = true;

                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                              document.getElementsByTagName("body")[0])
                        .appendChild(e);

                        
                        document.getElementById("show-comments").style.display = "none";
                  }
            }

            
            var hash = window.location.hash.substr(1);
            if (hash.length > 8) {
                  if (hash.substring(0, 8) == "comment-") {
                        disqus();
                  }
            }

            
            if (/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)) {
                  disqus();
            }
      })();
</script>
    





</main>
    <footer>
        <h6>Copyright &copy; 2018 - Thomas Mailund | 
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://mailund.dk/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="https://mailund.dk/js/scripts.js"></script>
</body>
<div id="amzn-assoc-ad-04956520-8388-43ab-9b6e-fbe758d208f8"></div>
<script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=04956520-8388-43ab-9b6e-fbe758d208f8"></script>

</html>