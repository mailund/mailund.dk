<!doctype html>

<html lang="en">

<head>
  <title>Mailund on the Internet</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="Thomas Mailund" />
  

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

<link rel="stylesheet" type="text/css" href="https://mailund.dk/css/styles.css" />
<link rel="stylesheet" href="https://cdn.rawgit.com/tonsky/FiraCode/1.205/distr/fira_code.css">

 
       <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid Sans" type="text/css" media="all" />
     
       <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Fira Mono" type="text/css" media="all" />
     

 <style>
 body {
     font-family: 'Droid Sans';
 }
 code {
    font-family: 'Fira Code';
 }
 </style>

 <script type="text/javascript" async
   src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
   MathJax.Hub.Queue(function() {
     
     
     
     var all = MathJax.Hub.getAllJax(), i;
     for(i = 0; i < all.length; i += 1) {
         all[i].SourceElement().parentNode.className += ' has-jax';
     }
   });

   MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
   });
   MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$$','$$'], ['\\(','\\)']],
     displayMath: [['$$$','$$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
          extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
   });
 </script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-10582357-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://mailund.dk/">Mailund on the Internet</a>
            </h1>

      <ul id="social-media">
        
        <li><a href="https://twitter.com/ThomasMailund"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.linkedin.com/in/thomas-mailund-94153b1"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://github.com/mailund"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://www.facebook.com/mailund"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://patreon.com/mailund"><i class="fab fa-patreon fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.goodreads.com/author/show/15484380.Thomas_Mailund"><i class="fab fa-goodreads fa-lg" aria-hidden="true"></i></a></li>
         
        <li><a href="https://www.stackoverflow.com/users/2170269/thomas-mailund"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a></li>
        
      </ul>
      
      <p><em>On Writing, Science, Programming and more</em></p>
      

    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://mailund.dk/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/posts">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/books/">
                <i class="fa-li fa  fa-lg"></i><span>Books</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/publications/">
                <i class="fa-li fa  fa-lg"></i><span>Publications</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://mailund.dk/software/">
                <i class="fa-li fa  fa-lg"></i><span>Software</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Chinese Remainder in Go</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2021-01-06T10:56:53&#43;01:00">Jan 6, 2021</time>
        </li>
        
        
        <li>
            Categories: 
            <em>
                
                    
                    <a href="https://mailund.dk/categories/go/">go</a>
                
                    , 
                    <a href="https://mailund.dk/categories/programming/">programming</a>
                
            </em>
        </li>
        

        
        <li>
            <em>
                
                    
                    <a href="https://mailund.dk/tags/go/">#Go</a>
                
                    , 
                    <a href="https://mailund.dk/tags/programming/">#Programming</a>
                
            </em>
        </li>
        

        <li>5 min read</li>
    </ul>
</aside>
    

    <p>In between exams, I plan to learn <a href="https://golang.org">Go</a> in January. I have a book I plan to follow, but today I wanted to get started by just jumping into it, so I picked the <a href="https://en.wikipedia.org/wiki/Chinese_remainder_theorem">Chinese Remainder Theorem</a> we used for 2020&rsquo;s Advent of Code <a href="https://mailund.dk/posts/aoc-2020-4/">Day 13</a>. There, I implemented it in Python (before I found out that it was already in SymPy). It is a simple numerical algorithm, so it should be easy to implement in Go. Or so I thought.</p>
<p>I only implemented the algorithm for two equations. Given numbers \(a,n,b,m\) with \(a &lt; n\) and \(b &lt; m\), find \(x\) such that \(x\) mod \(n = a\) and \(x\) mod \(m = b\). If you can do that, you can iteratively solve for any number of equations. To do that, however, I need to work out how to handle arrays in Go, and I didn&rsquo;t take it that far. I will do that later.</p>
<p>One way to solve the equations is to find the Bézout coefficients \(s\) and \(t\). Those are numbers such that \(sn+tm=1\), and if you have them, then your solution is \(x = atm + bsn\). To see this, note that because \(s\) and \(t\) are Bézout coefficients, \(sn = 1 - tm\) and \(tm = 1 - sn\), so \(x\) mod \(n\) = \((atm+bsn)\) mod \(n = atm\) mod \(n\) (because \(bsn\) is divisible by \(n\)) and \(atm\) mod \(n\) = \(a(1-sn)\) mod \(n\) = \(a\) mod \(n\) and symmetrically for \(b\) and \(m\). So, to find \(x\), you need to find \(s\) and \(t\). It isn&rsquo;t the only way, I think, but it is an easy way, because the <a href="https://en.wikipedia.org/wiki/Extended_Euclidean_algorithm">extended Euclidian algorithm</a> will do it for you.</p>
<p>The extended Euclidian algorithm works the same way as the Euclidian algorithm for computing the greatest common divisor of two numbers, you just keep track of two additional numbers in the computation. In Go, it looks like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000080;font-weight:bold">func</span> egcd(a, b <span style="color:#000080;font-weight:bold">int64</span>) (<span style="color:#000080;font-weight:bold">int64</span>, <span style="color:#000080;font-weight:bold">int64</span>, <span style="color:#000080;font-weight:bold">int64</span>) {
	oldR, r := a, b
	oldS, s := int64(<span style="color:#00f">1</span>), int64(<span style="color:#00f">0</span>)
	oldT, t := int64(<span style="color:#00f">0</span>), int64(<span style="color:#00f">1</span>)
	<span style="color:#000080;font-weight:bold">for</span> r != <span style="color:#00f">0</span> {
		quotient := oldR / r
		oldR, r = r, oldR-quotient*r
		oldS, s = s, oldS-quotient*s
		oldT, t = t, oldT-quotient*t
	}
	<span style="color:#000080;font-weight:bold">return</span> oldR, oldS, oldT
}
</code></pre></div><p>My implementation returns three numbers. The first is the GCD of <code>a</code> and <code>b</code>—which for the Chinese Remainder Theorem is one as the input must be co-primes—and the second and third are \(s\) and \(t\).</p>
<p>That is the easy part, because now we can get the solution with</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000080;font-weight:bold">func</span> crt(a, n, b, m <span style="color:#000080;font-weight:bold">int64</span>) (<span style="color:#000080;font-weight:bold">int64</span>, <span style="color:#000080;font-weight:bold">int64</span>) {
	K := n * m
	_, s, t := egcd(n, m)
	x := a*t*m + b*s*n
	<span style="color:#000080;font-weight:bold">if</span> x &lt; <span style="color:#00f">0</span> {
		x += K
	}
	<span style="color:#000080;font-weight:bold">return</span> x, K
}
</code></pre></div><p>Here, \(K\), is the product of \(n\) and \(m\) and \(x\) should be modulo that. It might be negative, and if it is, we move it one period of \(K\) up to get the corresponding equivalence class. Adjusting a number this way, when you work modulo some number is standard. Nothing exciting here.</p>
<p>In my Python implementation, that would be it. Python works with arbitrarily large integers, and while that can hurt performance when numbers grow large, it isn&rsquo;t an issue here. The benefit of using such numbers is that we do not get overflow. But with Go (and most languages), we have a fixed size for integers. I picked 64-bit numbers, because that often suffices, but not for me. In some of my test cases, the multiplications when creating \(x\) gave me overflow.</p>
<p>So I figured that I would do multiplication in 128-bit words and then take the remainder with \(K\). That way, I would avoid overflow in the individual multiplications, and if I take the remainder after each operation, I would stay in 64-bit integers. However, Go told me in friendly but no uncertain terms that <code>int128</code> was not a type. And that meant that I had to do the multiplication within the modulo group.</p>
<p>You can do that with iterative addition, but it is of course very slow. It is linear in the smallest of the factors. But I figured that I should definitely be able to multiply by two without overflow, or I might as well give up, so I implemented a logarithmic multiplication.^[Well, it depends on how you look at the data. I suppose it is pseudo-logarithmic, because it is logarithmic in the magnitude of the input and not the size of the input. It doesn&rsquo;t really matter what you call it; it is fast enough.] I don&rsquo;t know what it is called, but it is a standard algorithm. You multiply by two when you have an even number, and add when you have an odd.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000080;font-weight:bold">func</span> multmod(a, b, m <span style="color:#000080;font-weight:bold">int64</span>) <span style="color:#000080;font-weight:bold">int64</span> {
	<span style="color:#000080;font-weight:bold">var</span> result <span style="color:#000080;font-weight:bold">int64</span> = <span style="color:#00f">0</span>
	a %= m
	b %= m

	<span style="color:#000080;font-weight:bold">for</span> b != <span style="color:#00f">0</span> {
		<span style="color:#000080;font-weight:bold">if</span> b%<span style="color:#00f">2</span> != <span style="color:#00f">0</span> {
			result = (result + a) % m
		}

		a = (a * <span style="color:#00f">2</span>) % m
		b /= <span style="color:#00f">2</span>
	}

	<span style="color:#000080;font-weight:bold">return</span> result
}
</code></pre></div><p>I also wrote a function to handle moving a number from negative into the range \([0,\ldots,K-1]\):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000080;font-weight:bold">func</span> mod(a, m <span style="color:#000080;font-weight:bold">int64</span>) <span style="color:#000080;font-weight:bold">int64</span> {
	a %= m
	<span style="color:#000080;font-weight:bold">if</span> a &lt; <span style="color:#00f">0</span> {
		a += m
	}
	<span style="color:#000080;font-weight:bold">return</span> a
}
</code></pre></div><p>With those functions, a Chinese Remainder solution looks like this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000080;font-weight:bold">func</span> crt(a, n, b, m <span style="color:#000080;font-weight:bold">int64</span>) (<span style="color:#000080;font-weight:bold">int64</span>, <span style="color:#000080;font-weight:bold">int64</span>) {
	K := n * m
	_, s, t := egcd(n, m)
	atm := multmod(multmod(a, mod(t, K), K), m, K)
	bsn := multmod(multmod(b, mod(s, K), K), n, K)
	x := mod(atm+bsn, K)
	<span style="color:#000080;font-weight:bold">return</span> x, K
}
</code></pre></div><p>Somehow, I miss operator overloading right here, but I don&rsquo;t think Go has them. I should get started with my book so I can figure out what you can actually do in Go.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://mailund.dk/posts/aoc-2020-12/"><i class="fa fa-chevron-circle-left"></i> Advent of Code 2020 — day 24 remade</a>
        </li>
        
        
        <li>
            <a href="https://mailund.dk/posts/krofatter-1/">Krofatter Egon og Hjælpepakken — 1 <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    
        <section class="comments-block">
      <button id="show-comments" style="display: none;"><i class="fa fa-comments-o"></i> Add/View Comments</button>
</section>

<section id="disqus_thread"></section>

<script>
      (function () {
            
            
            if (window.location.hostname == "localhost")
                  return;

            var disqus_loaded = false;
            var disqus_shortname = 'mailund-dk';
            var disqus_button = document.getElementById("show-comments");

            disqus_button.style.display = "";
            disqus_button.addEventListener("click", disqus, false);

            function disqus() {

                  if (!disqus_loaded) {
                        disqus_loaded = true;

                        var e = document.createElement("script");
                        e.type = "text/javascript";
                        e.async = true;
                        e.src = "//" + disqus_shortname + ".disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] ||
                              document.getElementsByTagName("body")[0])
                        .appendChild(e);

                        
                        document.getElementById("show-comments").style.display = "none";
                  }
            }

            
            var hash = window.location.hash.substr(1);
            if (hash.length > 8) {
                  if (hash.substring(0, 8) == "comment-") {
                        disqus();
                  }
            }

            
            if (/bot|google|baidu|bing|msn|duckduckgo|slurp|yandex/i.test(navigator.userAgent)) {
                  disqus();
            }
      })();
</script>
    





</main>
    <footer>
        <h6>Copyright © 2020 - Thomas Mailund |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://mailund.dk/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="https://mailund.dk/js/scripts.js"></script>
</body>
<div id="amzn-assoc-ad-04956520-8388-43ab-9b6e-fbe758d208f8"></div>
<script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=04956520-8388-43ab-9b6e-fbe758d208f8"></script>

<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</html>
